<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Drunk - Punk</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    if (window.Pi) {
      Pi.init({ version: "2.0" });
    } else {
      console.warn("Pi SDK nebyl naƒçten!");
    }
  </script>
 <!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
 
<script>
 var piUsername = localStorage.getItem("piUser"); // nebo "piUsername" podle toho, jak to m√°≈° na indexu

if (!piUsername) {
  alert("You must be logged in with Pi! Go to the homepage and login first.");
  // Klidnƒõ rovnou p≈ôesmƒõruj na homepage
  window.location.href = "index.html";
}
</script>

 <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f8fa; margin: 0; padding: 0; }
    .nav-link-stats {
      background: #e26e08 !important;  /* zlat√°, nebo t≈ôeba #ff66a3, #a0e370, prostƒõ nƒõco co nikde jinde nen√≠ */
      color: #333 !important;
      border-radius: 11px;
      margin-left: 6px;
     font-size: 1.32em;  /* vƒõt≈°√≠ emoji, a≈• to sv√≠t√≠ */
     box-shadow: 0 2px 10px #ffd70033;
     border: 2.5px solid #fff;
     filter: saturate(1.4) brightness(1.12); 
    }
    h1 { text-align: center; color: #208278; margin-top: 80px; }
    @media (max-width: 600px) {
  h1 { margin-top: 30px;} /* nebo klidnƒõ 20px, uprav si podle oka */
  }
    .nav-bar { position: fixed; top: 0; left: 0; width: 100vw; background: #2196f3; color: white;
      display: flex; justify-content: flex-end; gap: 2px; z-index: 1000; box-shadow: 0 2px 8px #0002; padding: 7px 0; }
    .nav-link { color: white; padding: 7px 24px; text-decoration: none; font-weight: bold; font-size: 1.07em;
      border-radius: 0 0 10px 10px; transition: background 0.18s; display: flex; align-items: center; gap: 6px; }
    .nav-link.active, .nav-link:hover { background: #1760a3; }
    .container { max-width: 430px; margin: 18px auto 0 auto; background: #fff; border-radius: 14px;
      box-shadow: 0 2px 16px #b7d9db35; padding: 23px 18px 18px 18px;}
    .item-row { display: flex; align-items: center; border-bottom: 1px solid #eee;
      padding: 8px 0; font-size: 1.08em;}
    .item-row:last-child { border-bottom: none; }
    .item-emoji { font-size: 1.17em; margin-right:7px;}
    .item-label { flex: 1; }
    .item-val { min-width: 36px; text-align: right; font-variant-numeric: tabular-nums; margin-left: 12px;}
    .sell-btn { margin-left: 10px; background: #2196f3; color: white; border: none;
      border-radius: 5px; padding: 4px 10px; font-weight: bold; cursor: pointer;}
    .sell-btn:hover { background: #1760a3;}
    .msg { text-align: center; margin: 10px auto 0 auto; font-size: 1.1em; color: #1760a3; }
    @media (max-width:600px){
      .container{padding:10px;}
      .nav-link{padding:7px 8px;font-size:1em;}
      .nav-bar{flex-wrap:wrap; justify-content:center;}
      body { padding-top: 90px; }
    }
    #confirm-modal { display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:#0007; }
    .confirm-content {
      background:#fff; border-radius:14px; box-shadow:0 4px 32px #0005; max-width:340px;
      margin:14vh auto 0 auto; padding:30px 18px 20px 18px; text-align:center; position:relative;
      animation: pop-in .15s cubic-bezier(.27,1.42,.7,1.04);
    }
    #confirm-modal button { margin: 0 12px; }
    @keyframes pop-in {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  .back-disketa {
  position: fixed;
  top: 65px; /* nebo 60px podle p≈ôesn√© v√Ω≈°ky navigace! */
  left: 10px;
  font-size: 2em;
  background: #22c55e;
  border: none;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  cursor: pointer;
  padding: 0.08em 0.42em 0.13em 0.42em;
  z-index: 2002;
  transition: background 0.18s;
  line-height: 1.1em;
}

.back-disketa:hover {
  background: #16a34a;
}
@media (max-width:600px) {
  .back-disketa {
    top: 95px; /* pokud m√° navigace na mobilu vƒõt≈°√≠ v√Ω≈°ku */
    left: 10px;
    font-size: 1.6em;
    padding: 0.02em 0.33em 0.13em 0.33em;
  }
}
  </style>
</head>
<body>
  <div class="nav-bar">
    <a href="pestovani.html" class="nav-link">üå± Grow</a>
    <a href="vyroba.html" class="nav-link">‚öóÔ∏è Craftworks</a>
    <a href="jzd.html" class="nav-link">üê∑ Coop</a>
    <a href="sklad.html" class="nav-link">üì¶ Stash</a>
    <a href="hotel.html" class="nav-link">üè® Motel</a>
    <a href="pub.html" class="nav-link">üè° Bar</a>
    <a href="market.html" class="nav-link">üè™ Bazaar</a>
    <a href="finance.html" class="nav-link active">üí∞ Wallet</a>
    <a class="nav-link nav-link-stats" href="statistiky.html">üìä</a>
  </div>
  <button class="back-disketa" onclick="saveLocalStorageToCloud()" title="Save game to cloud">
  üíæ
</button>
  <h1>üí∞ Wallet</h1>
  <div id="balances" style="text-align:center; margin: 10px 0; font-weight: bold; font-size: 1.2em;">
    <b>üíµ Balance: <span id="money"></span> $<br>
    ü™ô PI Coins: <span id="pi-balance"></span></b> œñ
    <div id="msg" class="msg"></div>
    <div style="text-align:center; margin-top: 12px;">
      <button id="btn-dobit-pi" style="background:#2196f3; color:white; padding:6px 16px; border-radius:7px; font-weight:bold; cursor:pointer;">
        Top up œñ
      </button>
      <button id="btn-daily-login" style="background:#4caf50; color:white; padding:6px 16px; border-radius:7px; font-weight:bold; cursor:pointer; margin-left: 8px;">
        Daily Login
      </button>
    </div>
  </div>

  <!-- Modal okno confirm -->
  <div id="confirm-modal">
    <div class="confirm-content">
      <div id="confirm-text" style="font-size:1.13em; color:#1760a3; margin-bottom:21px;"></div>
      <button id="confirm-ok" style="background:#2196f3; color:#fff; border:none; border-radius:8px; padding:7px 22px; margin:0 10px; font-weight:bold; font-size:1.04em; cursor:pointer;">OK</button>
      <button id="confirm-cancel" style="background:#eee; color:#333; border:none; border-radius:8px; padding:7px 22px; margin:0 10px; font-weight:bold; font-size:1.04em; cursor:pointer;">Cancel</button>
    </div>
  </div>

  <!-- Daily login modal -->
  <div id="daily-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px #0005; z-index:2000; text-align:center;">
    <h3>Daily Login</h3>
    <div style="font-size:0.95em; color:#444; margin-bottom: 8px;">
Every 6th day <b>+50 œñ</b>, on the 30th day <b>+100 œñ</b> üéÅ
</div>
    <div id="login-timer" style="color:#1760a3; font-weight:bold; font-size: 1em; margin-bottom: 12px;"></div>
    <div id="login-days" style="display:grid; grid-template-columns:repeat(6, 1fr); gap:6px; margin:10px 0;"></div>
    <button onclick="closeDailyModal()" style="margin-top:10px; padding:5px 12px;">Close</button>
  </div>

  <div class="container">
   <div id="modal-overlay" style="display:none; position:fixed; z-index:9998; left:0; top:0; width:100vw; height:100vh; background:#0007;"></div>
<div id="sell-modal" style="display:none; position:fixed; z-index:9999; left:50%; top:50%; transform:translate(-50%,-50%); background:white; border-radius:13px; box-shadow:0 0 18px #0005; padding:26px 20px; min-width:260px;">
  <h3 id="modal-title" style="margin-bottom:12px;"></h3>
  <div style="font-size:1.5em; margin-bottom:6px;"><span id="modal-emoji"></span> <span id="modal-label"></span></div>
  <div style="margin-bottom:10px;">
    <button id="modal-minus" style="font-size:1.25em; width:32px;">‚àí</button>
    <input type="number" id="modal-amount" style="width:50px; text-align:center; font-size:1.2em;" min="1" value="1">
    <button id="modal-plus" style="font-size:1.25em; width:32px;">+</button>
  </div>
  <div style="color:#888; font-size:0.98em; margin-bottom:9px;">Available: <span id="modal-available"></span></div>
  <div id="modal-price" style="font-weight:bold; color:#1d9539; font-size:1.09em; margin-bottom:15px;"></div>
  <div>
    <button id="modal-sell" style="background:#2196f3; color:#fff; border:none; border-radius:8px; padding:8px 20px; font-weight:bold; font-size:1.03em; cursor:pointer;">Sell</button>
    <button id="modal-cancel" style="background:#eee; color:#333; border:none; border-radius:8px; padding:8px 20px; font-weight:bold; font-size:1.03em; cursor:pointer; margin-left: 10px;">Cancel</button>
  </div>
</div>

  <div id="sell-list"></div>
  </div>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyCfPJJL8cbfxmpWpHG5_icQOZjzGWSpeZI",
    authDomain: "drunk-punk.firebaseapp.com",
    projectId: "drunk-punk",
    storageBucket: "drunk-punk.appspot.com", // POZOR! M√° b√Ωt .app**spot**.com
    messagingSenderId: "749798531604",
    appId: "1:749798531604:web:9e702aee7c9a2599627d01",
    measurementId: "G-JSFRP622EL"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const firestore = firebase.firestore();

// Automaticky p≈ôihl√°s√≠ anonymnƒõ, pokud nejsi p≈ôihl√°≈°en
firebase.auth().onAuthStateChanged(function(user) {
    if (!user) {
        firebase.auth().signInAnonymously();
    }
});
</script>

<script>
const defaultPrices = {
  p≈°enice: 4, ryze: 10, chmel: 9, kuku≈ôice: 12, reva: 12, broskve: 20, meru≈àky: 18, jablko: 13, hru≈°ky: 13, ≈°vestky: 13, mrkev: 9, brambora: 11,  rajƒçata: 12, chilli: 15, okurky: 13,
  cibule: 14, ƒçesnek: 16, jahody: 25, t≈ôe≈°nƒõ: 15, trtina: 14,
  kvas_pivo: 18, kvas_vino: 45, most_cider: 50,
  kvas_≈°vestky: 17, kvas_hru≈°ky: 15, kvas_meru≈àky: 18, kvas_broskve: 19, kvas_jablka: 15, kvas_psenice: 12, kvas_kuku≈ôice: 14, kvas_brambora: 15,
  pivo: 32, vino: 60, cider: 70, popkorn: 50, hranolky: 60, testo: 10, bread: 30, curd: 45, nudle: 40, goat_cheese: 50, fried_egg: 35, bacon: 70, turkey_hamburger: 60,
  ml√©ko: 30, koz√≠_ml√©ko: 45, vejce: 15, ≈°unka: 45, kr≈Øt√≠_maso: 30, med: 45, vlna: 60, kachn√≠_vejce: 30, kr√°liƒç√≠_maso: 45,
  palenka_≈°vestky: 46, palenka_hru≈°ky: 44, palenka_meru≈àky: 48, palenka_broskve: 50, palenka_jablka: 44, vodka_psenice: 35, whiskey_kukurice: 40, rum_brambora: 42, 
  marmelada_broskve: 70, marmelada_meru≈àky: 65, marmelada_jahody: 70, marmelada_t≈ôe≈°nƒõ: 68, marmelada_≈°vestky: 67, marmelada_hru≈°ky: 64, marmelada_jablko: 63, shrimp: 70,
  crab: 70, fish: 70, octopus: 70, tempura: 70, sugar: 25, candy: 40, lollipop: 65,
};


if (!localStorage.getItem("lihobaronFarmXP")) localStorage.setItem("lihobaronFarmXP", 0);
if (!localStorage.getItem("lihobaronFarmCoins")) localStorage.setItem("lihobaronFarmCoins", 200);
if (!localStorage.getItem("lihobaronPi")) localStorage.setItem("lihobaronPi", 200);

function getMoney() {
  let val = localStorage.getItem("lihobaronFarmCoins");
  return val === null ? 0 : parseInt(val) || 0;
}
function setMoney(v) {
  document.getElementById("money").textContent = v;
  localStorage.setItem("lihobaronFarmCoins", v);
}
function getPi() {
  let val = localStorage.getItem("lihobaronPi");
  if (!val) return 0;
  try { return JSON.parse(val); }
  catch (e) { return parseInt(val) || 0; }
}
function setPi(v) {
  document.getElementById("pi-balance").textContent = v;
  localStorage.setItem("lihobaronPi", JSON.stringify(v));
}
function flashMsg(text, ms = 1200){
  const el = document.getElementById("msg");
  if (!el) return;
  el.textContent = text;
  setTimeout(() => { el.textContent = ""; }, ms);
}

function showMsg(m){ flashMsg(m, 1800); }



const LOGIN_KEY = "lihoDailyLogin";
const MAX_DAYS = 30;

function initDailyLogin() {
  const raw = localStorage.getItem(LOGIN_KEY);
  let data = raw ? JSON.parse(raw) : { days: [], last: null };

  const now = new Date();
  const todayStr = now.toDateString();
  const container = document.getElementById("login-days");
  container.innerHTML = "";

// vykreslen√≠ 30 dn√≠
for (let i = 0; i < MAX_DAYS; i++) {
  const div = document.createElement("div");
  const dayNum = i + 1;
  const claimed = data.days.includes(i);

  div.textContent = dayNum;
  div.style.padding = "10px";
  div.style.borderRadius = "50%";
  div.style.textAlign = "center";
  div.style.color = "white";

  // BONUS dny: ka≈æd√Ω 6. a 30.
  if (dayNum % 6 === 0 || dayNum === 30) {
    div.style.outline = "3px solid gold";
    div.style.outlineOffset = "2px";

    // pokud u≈æ je claimed ‚Üí ƒçervenƒõ
    if (claimed) {
      div.style.background = "crimson";
    } else {
      div.style.background = "#ccc";
    }
  } else {
    // norm√°ln√≠ dny
    div.style.background = claimed ? "#4caf50" : "#ccc";
  }

  container.appendChild(div);
}



  const btn = document.getElementById("btn-daily-login");
  const timerDiv = document.getElementById("login-timer");
  const last = data.last ? new Date(data.last) : null;
  const isNewDay = !last || last.toDateString() !== todayStr;

  if (isNewDay) {
    btn.textContent = "Daily Login";
    timerDiv.textContent = "";
  } else {
    btn.textContent = "Already claimed";
    const midnight = new Date();
    midnight.setHours(24, 0, 1, 0);
    function updateCountdown() {
      const sec = Math.floor((midnight - new Date()) / 1000);
      if (sec <= 0) {
        timerDiv.textContent = "You can now claim again!";
        initDailyLogin();
        return;
      }
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      timerDiv.textContent = "‚è≥ Next login in " + h + "h " + m + "m " + s + "s";
      setTimeout(updateCountdown, 1000);
    }
    updateCountdown();
  }
}

document.getElementById("btn-daily-login").addEventListener("click", function () {
  const SIXTH_REWARD = 50;       // ka≈æd√Ωch 6 dn√≠
  const THIRTIETH_REWARD = 100;  // 30. den

  const raw = localStorage.getItem(LOGIN_KEY);
  let data = raw ? JSON.parse(raw) : { days: [], last: null };

  const now = new Date();
  const last = data.last ? new Date(data.last) : null;
  const isNewDay = !last || last.toDateString() !== now.toDateString();

  if (isNewDay) {
    // p≈ôid√°me dne≈°n√≠ index
    data.days.push(data.days.length);
    data.last = now.getTime();

    const currentDay = data.days.length;

    // odmƒõny
    if (currentDay === 30) {
      setPi(getPi() + THIRTIETH_REWARD);
      flashMsg("üéâ Day 30 bonus: +100 œñ!");
      // reset cyklu
      data.days = [];
      data.last = now.getTime();
    } else if (currentDay % 6 === 0) {
      setPi(getPi() + SIXTH_REWARD);
      flashMsg("‚úÖ Day " + currentDay + " bonus: +" + SIXTH_REWARD + " œñ");
    }

    localStorage.setItem(LOGIN_KEY, JSON.stringify(data));
  }
  document.getElementById("modal-overlay").style.display = "none";
  document.getElementById("daily-modal").style.display = "block";
  initDailyLogin();
});

function closeDailyModal() {
  document.getElementById("daily-modal").style.display = "none";
}


function showConfirm(text, cb) {
  var modal = document.getElementById("confirm-modal");
  document.getElementById("confirm-text").textContent = text;
  modal.style.display = "block";
  function cleanup(ok) {
    modal.style.display = "none";
    document.getElementById("confirm-ok").onclick = null;
    document.getElementById("confirm-cancel").onclick = null;
    cb(ok);
  }
  document.getElementById("confirm-ok").onclick = function() { cleanup(true); };
  document.getElementById("confirm-cancel").onclick = function() { cleanup(false); };
}

// Prodej v√Ωrobk≈Ø (star√Ω)
const items = [
 // Plodiny
      { key: "p≈°enice", label: "Wheat", emoji: "üåæ" },
      { key: "ryze", label: "Rice", emoji: "üçö" },
      { key: "chmel", label: "Hops", emoji: "üçÉ" },
      { key: "kuku≈ôice", label: "Corn", emoji: "üåΩ" },
      { key: "trtina", label: "Sugar Cane", emoji: "üéã" },
      { key: "reva", label: "Grapes", emoji: "üçá" },
      { key: "broskve", label: "Peaches", emoji: "üçä" },
      { key: "meru≈àky", label: "Apricots", emoji: "üçë" },
      { key: "jablko", label: "Apple", emoji: "üçé" },
      { key: "hru≈°ky",  label: "Pears", emoji: "üçê" },
      { key: "≈°vestky", label: "Plums", emoji: "üü£" },
      { key: "mrkev", label: "Carrot", emoji: "ü•ï" },
      { key: "brambora", label: "Potatoes", emoji: "ü•î" },
      { key: "rajƒçata", label: "Tomatoes", emoji: "üçÖ" },
      { key: "chilli", label: "Chilli", emoji: "üå∂" },
      { key: "okurky", label: "Cucumbers", emoji: "ü•í" },
      { key: "cibule", label: "Onion", emoji: "üßÖ" },
      { key: "ƒçesnek", label: "Garlic", emoji: "üßÑ" },
      { key: "jahody", label: "Strawberries", emoji: "üçì" },
      { key: "t≈ôe≈°nƒõ", label: "Cherries", emoji: "üçí" },
      // Kvasy a most
      { key: "kvas_pivo", label: "Beer wort", emoji: "üç∫üß™" },
      { key: "kvas_vino", label: "Wine wort", emoji: "üßÉ" },
      { key: "most_cider", label: "Juice", emoji: "üçéüß™" }, 
      { key: "popkorn", label: "Popcorn", emoji: "üçø" },
      { key: "hranolky", label: "Fries", emoji: "üçü" },
      { key: "kvas_≈°vestky", label: "Plum wort", emoji: "üü£üß™" },
      { key: "kvas_hru≈°ky",  label: "Pear wort", emoji: "üçêüß™" },
      { key: "kvas_jablka", label: "Apple wort", emoji: "üçèüß™" },
      { key: "kvas_meru≈àky", label: "Apricot wort", emoji: "üçëüß™" },
      { key: "kvas_broskve", label: "Peach wort", emoji: "üçäüß™" },
      { key: "kvas_kuku≈ôice", label: "Corn wort", emoji: "üåΩ" },
      { key: "kvas_psenice",  label: "Wheat wort", emoji: "üåæ" },
      { key: "kvas_brambora", label: "Potatoes wort", emoji: "ü•î" },
      // V√Ωrobky a p√°lenky
      { key: "pivo",        label: "Beer", emoji: "üçª" },
      { key: "vino",        label: "Wine", emoji: "üç∑" },
      { key: "cider",       label: "Cider", emoji: "üç∂" }, 
      { key: "ml√©ko", label: "Milk", emoji: "ü•õ" },
      { key: "curd", label: "Curd", emoji: "üç•" },
      { key: "nudle", label: "Noodles", emoji: "üçú" },
      { key: "sugar", label: "Sugar", emoji: "üßÇ" },
      { key: "candy", label: "Candy", emoji: "üç¨" },
      { key: "lollipop", label: "Lollipop", emoji: "üç≠" },
      { key: "turkey_hamburger", label: "Turkey hamburger", emoji: "üçî" },
      { key: "goat_cheese", label: "Goat cheese", emoji: "üßÄ" },
      { key: "shrimp", label: "Shrimp", emoji: "ü¶ê" },
      { key: "crab", label: "Crab", emoji: "ü¶Ä" },
      { key: "fish", label: "Fish", emoji: "üêü" },
      { key: "octopus", label: "Octopus", emoji: "üêô" },
      { key: "tempura", label: "Tempura", emoji: "üç§" },
      { key: "koz√≠_ml√©ko", label: "Goat milk", emoji: "ü•õ" },
      { key: "vejce", label: "Egg", emoji: "ü•ö" },
      { key: "fried_egg", label: "Fried egg", emoji: "üç≥" },
      { key: "bacon", label: "Bacon", emoji: "ü•ì" },
      { key: "testo",label: "Dough",emoji: "ü•£" },
      { key: "bread", label: "Bread", emoji: "üçû" },
      { key: "≈°unka", label: "Ham", emoji: "üçñ" },
      { key: "kr≈Øt√≠_maso", label: "Turkey meat", emoji: "üçó" },
      { key: "med", label: "Honey", emoji: "üçØ" },
      { key: "vlna", label: "Wool", emoji: "üß∂" },
      { key: "kr√°liƒç√≠_maso", label: "Rabbit meat", emoji: "ü•©" },
      { key: "kachn√≠_vejce", label: "Duck egg", emoji: "ü•ö" },
      { key: "palenka_≈°vestky", label: "Slivovitz", emoji: "üü£ü•É" },
      { key: "palenka_hru≈°ky",  label: "Pear brandy", emoji: "üçêü•É" },
      { key: "palenka_jablka", label: "Calvados", emoji:¬†"üçèü•É"¬†},
      { key: "palenka_meru≈àky", label: "Apricot brandy", emoji: "üçëü•É" },
      { key: "palenka_broskve", label: "Peach brandy", emoji: "üçäü•É" },
      { key: "whiskey_kukurice", label: "Whiskey", emoji: "ü•É" },
      { key: "vodka_psenice",    label: "Vodka", emoji: "üç∏" },
      { key: "rum_brambora",     label: "Rum", emoji: "üè¥‚Äç‚ò†Ô∏è" },
      // ... ostatn√≠ polo≈æky ...
      { key: "marmelada_broskve", label: "Peach jam", emoji: "üçäüçØ" },
      { key: "marmelada_meru≈àky", label: "Apricot jam", emoji: "üçëüçØ" },
      { key: "marmelada_jahody",  label: "Strawberry jam", emoji: "üçìüçØ" },
      { key: "marmelada_t≈ôe≈°nƒõ",  label: "Cherry jam", emoji: "üçíüçØ" },
      { key: "marmelada_≈°vestky", label: "Plum jam", emoji: "üü£üçØ" },
      { key: "marmelada_hru≈°ky",  label: "Pear jam", emoji: "üçêüçØ" },
      { key: "marmelada_jablko",  label: "Apple jam", emoji: "üçèüçØ" },

    ];

const animalDefs = {
  slepice: { nazev: "Hen", emoji: "üêî", cena: 100 },
  kachna:  { nazev: "Duck", emoji: "ü¶Ü", cena: 150 },
  krocan:  { nazev: "Turkey", emoji: "ü¶É", cena: 200 },
  kr√°l√≠k:  { nazev: "Rabbit", emoji: "üêá", cena: 300 },
  ovce:    { nazev: "Sheep",   emoji: "üêë", cena: 500 },
  prase:   { nazev: "Pig", emoji: "üê∑", cena: 600 },
  koza:    { nazev: "Goat", emoji: "üêê", cena: 700 },
  krava:   { nazev: "Cow", emoji: "üêÆ", cena: 1000 },
  vcela:   { nazev: "Bee", emoji: "üêù", cena: 700 }
 
}; 
const prices = {...defaultPrices}; // nebo co pou≈æ√≠v√°≈°

function getSklad() {
  return JSON.parse(localStorage.getItem("lihobaronFarmStorage") || "{}");
}
function setSklad(obj) {
  localStorage.setItem("lihobaronFarmStorage", JSON.stringify(obj));
}
function getAnimals() {
  return JSON.parse(localStorage.getItem("lihobaronZvirata") || "[]");
}
function setAnimals(arr) {
  localStorage.setItem("lihobaronZvirata", JSON.stringify(arr));
}

// Render sell-list
function renderSellList() {
  let sklad = getSklad();
  let animals = getAnimals();
  let html = "";

  // Items
  items.forEach((item) => {
    let val = sklad[item.key] || 0;
    if (val > 0) {
      html += `<div class="item-row">
        <span class="item-emoji">${item.emoji}</span>
        <span class="item-label">${item.label}</span>
        <div style="margin-left:auto;text-align:right;">
          <span style="color:#888;">Amount: <b>${val}</b></span>
          <button class="sell-btn" onclick="openSellModal('item','${item.key}',${val})">Sell</button>
        </div>
      </div>`;
    }
  });
  // Animals
  Object.keys(animalDefs).forEach(key => {
    let count = animals.filter(a => a.typ === key && !a.mrtve).length;
    if (count > 0) {
      html += `<div class="item-row">
        <span class="item-emoji">${animalDefs[key].emoji}</span>
        <span class="item-label">${animalDefs[key].nazev}</span>
        <div style="margin-left:auto;text-align:right;">
          <span style="color:#888;">Count: <b>${count}</b></span>
          <button class="sell-btn" onclick="openSellModal('animal','${key}',${count})">Sell</button>
        </div>
      </div>`;
    }
  });

  if (!html) html = "<div style='text-align:center;color:#aaa;margin-top:17px;'>Nothing to sell! Go make some booze or breed animals!</div>";
  document.getElementById("sell-list").innerHTML = html;
}

// Modal logic
let currentMode, currentKey, currentMax;
function openSellModal(mode, key, max) {
  currentMode = mode; currentKey = key; currentMax = max;
  document.getElementById("modal-title").textContent = "How many do you want to sell?";
  document.getElementById("modal-amount").value = 1;
  document.getElementById("modal-amount").min = 1;
  document.getElementById("modal-amount").max = max;
  document.getElementById("modal-available").textContent = max;
  let emoji = mode === "item" ? items.find(i=>i.key===key).emoji : animalDefs[key].emoji;
  let label = mode === "item" ? items.find(i=>i.key===key).label : animalDefs[key].nazev;
  document.getElementById("modal-emoji").textContent = emoji;
  document.getElementById("modal-label").textContent = label;
  updateModalPrice();
  document.getElementById("sell-modal").style.display = "block";
  document.getElementById("modal-overlay").style.display = "block";
}
function closeSellModal() {
  document.getElementById("sell-modal").style.display = "none";
  document.getElementById("modal-overlay").style.display = "none";
}
function updateModalPrice() {
  let n = parseInt(document.getElementById("modal-amount").value) || 1;
  if (n < 1) n = 1;
  if (n > currentMax) n = currentMax;
  document.getElementById("modal-amount").value = n;
  let price = 0;
  if (currentMode === "animal") price = Math.floor(animalDefs[currentKey].cena * 0.6 * n);
  else price = prices[currentKey] * n;
  document.getElementById("modal-price").textContent = `You will get: ${price} $`;
}
document.getElementById("modal-minus").onclick = function() {
  let v = parseInt(document.getElementById("modal-amount").value) || 1;
  if (v > 1) { document.getElementById("modal-amount").value = v-1; updateModalPrice(); }
};
document.getElementById("modal-plus").onclick = function() {
  let v = parseInt(document.getElementById("modal-amount").value) || 1;
  if (v < currentMax) { document.getElementById("modal-amount").value = v+1; updateModalPrice(); }
};
document.getElementById("modal-amount").oninput = updateModalPrice;
document.getElementById("modal-cancel").onclick = closeSellModal;

document.getElementById("modal-sell").onclick = function() {
  let n = parseInt(document.getElementById("modal-amount").value) || 1;
  let coins = parseInt(localStorage.getItem("lihobaronFarmCoins") || "0");
  if (currentMode === "item") {
    let sklad = getSklad();
    if (sklad[currentKey] < n) return alert("Not enough in stock!");
    sklad[currentKey] -= n;
    setSklad(sklad);
    coins += prices[currentKey] * n;
  } else {
    let animals = getAnimals();
    let sold = 0;
    for (let i = animals.length-1; i >= 0 && sold < n; i--) {
      if (animals[i].typ === currentKey && !animals[i].mrtve) {
        animals.splice(i, 1); sold++;
      }
    }
    setAnimals(animals);
    coins += Math.floor(animalDefs[currentKey].cena * 0.6 * sold);
  }
  setMoney(coins);
  closeSellModal();
  renderSellList();
  flashMsg("Sold! üí∏");

};

renderSellList();




document.getElementById("btn-dobit-pi").onclick = async function () {
  var btn = document.getElementById("btn-dobit-pi");
  if (!window.Pi) {
    alert("Pi SDK nen√≠ dostupn√©! Otev≈ôi str√°nku v Pi Browseru.");
    return;
  }
  btn.disabled = true;
  btn.style.opacity = "0.65";
  btn.textContent = "Please wait...";

  var backendUrl = "https://backend-production-9cdf.up.railway.app";
  try {
    const scopes = ["payments", "username"];
    const auth = await Pi.authenticate(scopes, function (payment) {
      alert("Incomplete payment: " + JSON.stringify(payment));
    });
    if (!auth || !auth.accessToken || !auth.user) {
      alert("Chyba p≈ôi autentizaci!");
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.textContent = "Top up œñ";
      return;
    }
    const paymentData = {
      amount: 5,
      memo: "Top up 600 tokens",
      metadata: { type: "topup", amount: 600 }
    };
    Pi.createPayment(paymentData, {
      onReadyForServerApproval: function (paymentId) {
        fetch(backendUrl + "/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId: paymentId })
        })
        .then(function(res){ return res.json(); })
        .then(function(data){ })
        .catch(function(err){
          alert("Backend /approve ERR: " + err);
        });
      },
      onReadyForServerCompletion: function (paymentId, txid) {
        fetch(backendUrl + "/complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId: paymentId, txid: txid })
        })
        .then(function(res){ return res.json(); })
        .then(function(data){
          setPi(getPi() + 600);
          alert("600 PI added! üéâ");
          // Po √∫spƒõ≈°n√© platbƒõ cooldown na 5 min:
          btn.textContent = "Try again in 5 min";
          btn.disabled = true;
          btn.style.opacity = "0.5";
          localStorage.setItem("piRechargeCooldown", Date.now());
          setTimeout(function() {
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.textContent = "Top up œñ";
          }, 5 * 60 * 1000);
        })
        .catch(function(err){
          alert("Backend /complete ERR: " + err);
          btn.disabled = false;
          btn.style.opacity = "1";
          btn.textContent = "Top up œñ";
        });
      },
      onCancel: function (paymentId) {
        alert("Payment was cancelled by the user!");
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.textContent = "Top up œñ";
      },
      onError: function (err, payment) {
        alert("Chyba v platbƒõ: " + (err && err.message ? err.message : err));
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.textContent = "Top up œñ";
      }
    });
  } catch (e) {
    alert("Chyba ve flow: " + (e && e.message ? e.message : e));
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.textContent = "Top up œñ";
  }
};

// P≈ôi naƒçten√≠ str√°nky blokuj pokud bƒõ≈æ√≠ cooldown:
(function(){
  var btn = document.getElementById("btn-dobit-pi");
  var last = parseInt(localStorage.getItem("piRechargeCooldown")||"0",10);
  if (last && (Date.now() - last) < 5*60*1000) {
    btn.disabled = true;
    btn.style.opacity = "0.5";
    btn.textContent = "Try again in 5 min";
    setTimeout(function(){
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.textContent = "Top up œñ";
    }, 5*60*1000 - (Date.now() - last));
  }
})();


renderSellList();
initDailyLogin();
setMoney(getMoney());
setPi(getPi());

function saveLocalStorageToCloud() {
    var piUser = localStorage.getItem("piUser");
    if (!piUser) {
        if (!window.Pi) {
            showMsg("Pi SDK is not loaded!");
            return;
        }
        Pi.authenticate(["username"], function () { })
            .then(function (auth) {
                if (auth && auth.user && auth.user.username) {
                    localStorage.setItem("piUser", auth.user.username);
                    saveLocalStorageToCloud();
                } else {
                    showMsg("Failed to sign in.");
                }
            })
            .catch(function (err) {
                showMsg("Login error: " + err.message);
            });
        return;
    }

    // 1. St√°hni existuj√≠c√≠ cloudovou XP historii
    firestore.collection("pi_saves").doc(piUser).get().then(function(doc) {
        var oldXPHistory = [];
        if (doc.exists && doc.data().data && doc.data().data.xpHistory) {
            try {
                oldXPHistory = Array.isArray(doc.data().data.xpHistory)
                    ? doc.data().data.xpHistory
                    : JSON.parse(doc.data().data.xpHistory);
            } catch (e) { oldXPHistory = []; }
        }
        // 2. XP historie z localStorage
        var localXPHistory = [];
        try {
            localXPHistory = JSON.parse(localStorage.getItem("xpHistory") || "[]");
        } catch (e) { localXPHistory = []; }
        // 3. Spoj bez duplicit
        var allXPHistory = oldXPHistory.concat(localXPHistory.filter(function(newItem){
            return !oldXPHistory.some(function(oldItem){
                return oldItem.timestamp === newItem.timestamp && oldItem.xp === newItem.xp;
            });
        }));
        // 4. P≈ôidej aktu√°ln√≠ XP pokud je nov√©
        var currentXP = parseInt(localStorage.getItem("lihobaronFarmXP") || "0", 10);
        if (!allXPHistory.length || allXPHistory[allXPHistory.length-1].xp !== currentXP) {
            allXPHistory.push({xp: currentXP, timestamp: Date.now()});
        }
        // 5. Ulo≈æ do localStorage i do dat pro cloud
        localStorage.setItem("xpHistory", JSON.stringify(allXPHistory));
        var data = {};
        for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            data[key] = localStorage.getItem(key);
        }
        data.xpHistory = allXPHistory;
        data.piUser = piUser;

        // 6. Ulo≈æ do cloudu
        firestore.collection("pi_saves").doc(piUser).set({
            data: data,
            savedAt: new Date().toISOString()
        }).then(function () {
            showMsg("‚úÖ Game saved!");
        }).catch(function (error) {
            showMsg("Saving error: " + error.message);
        });
    });
}


</script>
</body>
</html>