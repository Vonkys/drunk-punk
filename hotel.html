<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Drunk - Punk</title>
 <link rel="icon" href="favicon.ico" type="image/x-icon" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f8fa; margin: 0; padding: 0; padding-top: 48px;}
.nav-bar { position: fixed; top: 0; left: 0; width: 100vw; background: #2196f3; color: white; display: flex; justify-content: flex-end; gap: 2px; z-index: 1000; box-shadow: 0 2px 8px #0002; padding: 7px 0; }
h1 { text-align: center; color: #208278; margin-top: 30px; }
@media (max-width: 600px) { h1 { margin-top: 70px;} }
.nav-link { color: white; padding: 7px 24px; text-decoration: none; font-weight: bold; font-size: 1.07em; border-radius: 0 0 10px 10px; transition: background 0.18s; display: flex; align-items: center; gap: 6px; }
.nav-link.active, .nav-link:hover { background: #1760a3; }
@media (max-width:520px) { .nav-bar { font-size: 0.97em; } }
@media (max-width:600px) { .nav-bar { justify-content: center; flex-wrap: wrap; font-size: 0.97em; } .nav-link { padding: 7px 8px; font-size: 1em;} }
.nav-link-stats { background: #e26e08 !important; color: #333 !important; border-radius: 11px; margin-left: 6px; font-size: 1.32em; box-shadow: 0 2px 10px #ffd70033; border: 2.5px solid #fff; filter: saturate(1.4) brightness(1.12);}
.back-disketa { position: fixed; top: 65px; left: 10px; font-size: 2em; background: #22c55e; border: none; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; padding: 0.08em 0.42em 0.13em 0.42em; z-index: 2002; transition: background 0.18s; line-height: 1.1em;}
.back-disketa:hover { background: #16a34a; }
@media (max-width:600px) { .back-disketa { top: 95px; left: 10px; font-size: 1.6em; padding: 0.02em 0.33em 0.13em 0.33em; } }
/* HLAVIƒåKA BALANCE ... */
.balance-header { max-width: 420px; margin: 25px auto 20px auto; text-align: center; }
@media (max-width: 600px) {
  .balance-header {
    margin-top: 75px !important;
  }
}
.header-title { font-size: 2.3em; font-weight: bold; color: #2196f3; display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 2px;}
.header-title-emoji { font-size: 1.5em; }
#balances { text-align:center; margin: 10px 0 18px 0; font-weight: bold; font-size: 1.2em;}
/* Motel vizu√°ly */
#motel-manager { max-width: 730px; margin: 28px auto; background: #fff; border-radius: 22px; box-shadow: 0 2px 18px #dde1ea55; padding: 20px 18px 30px 18px;}
.motel-title { font-size: 2em; font-weight: bold; text-align: center; color: #1e4185; margin-bottom: 5px; margin-top: 7px; display: flex; justify-content: center; align-items: center; gap: 12px;}
.rooms-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;}
.room-card { background: #f5f5fc; border-radius: 12px; box-shadow: 0 1px 6px #aaa2; padding: 14px 13px 15px 13px; min-width: 120px; max-width: 155px; text-align: center; margin-bottom: 8px;}
.room-title { font-weight: bold; font-size: 1.09em; color: #18708a; margin-bottom: 5px;}
.room-status { margin: 7px 0 5px 0; font-size: 1.08em; color: #8d8d8d;}
.buy-btn { padding: 7px 19px; background: #f47613; color: #fff; border: none; border-radius: 7px; font-weight: bold; cursor: pointer; font-size: 1em; margin-top: 8px; transition: background 0.15s;}
.buy-btn:hover { background: #d65b00; }
.equip-btn { padding: 5px 13px; background: #43a047; color: #fff; border: none; border-radius: 7px; font-weight: bold; cursor: pointer; font-size: 0.97em; margin-top: 8px;}
.equip-btn:hover { background: #2e7d32; }
.equip-list { margin: 8px 0 0 0; font-size: 0.99em; color: #555; text-align: left; min-height: 28px;}
.guest-bar { margin:22px auto 12px auto; max-width:480px; background:#ebf4fa; border-radius:13px; box-shadow:0 1px 10px #c9e8ff3a; padding:14px 13px; display:flex; flex-direction:column; align-items:center;}
.guest-bar strong {color:#18708a;}
</style>
</head>
<body>
  <div class="nav-bar">
    <a href="pestovani.html" class="nav-link">üå± Grow</a>
    <a href="vyroba.html" class="nav-link">‚öóÔ∏è Craftworks</a>
    <a href="jzd.html" class="nav-link">üê∑ Coop</a>
    <a href="sklad.html" class="nav-link">üì¶ Stash</a>
    <a href="hotel.html" class="nav-link active">üè® Motel</a>
    <a href="pub.html" class="nav-link">üè° Bar</a>
    <a href="market.html" class="nav-link">üè™ Bazaar</a>
    <a href="finance.html" class="nav-link">üí∞ Wallet</a>
    <a class="nav-link nav-link-stats" href="statistiky.html">üìä</a>  
  </div>
  <button class="back-disketa" onclick="saveLocalStorageToCloud()" title="Save game to cloud">üíæ</button>

  <div class="balance-header">
  <div class="header-title">
    <span class="header-title-emoji">üè®</span>
    Motel
  </div>
  <div id="balances">
    <b>
      <span style="font-size:1.5em;">üíµ</span>
      Balance: <span id="balance-value">?</span> $
      <br>
      <span style="font-size:1.5em;">ü™ô</span>
      PI Coins: <span id="pi-value">?</span> œñ
    </b>
  </div>
  <!-- Hl√°≈°ka hned pod z≈Østatky! -->
  <div id="msg" style="color:#1760a3; margin:14px 0 0 0; font-weight:bold; font-size:1.13em; text-align:center; width:100%; display:block;"></div>
</div>

<!-- Host panel a zbytek str√°nky z≈Øst√°v√° stejnƒõ -->
<div id="guest-bar" class="guest-bar" style="display:none"></div>
<button id="nextGuestBtn" style="margin:10px auto 18px auto;display:block;font-size:1.2em;padding:7px 18px 8px 18px;border-radius:12px;background:#18a5d1;color:#fff;border:none;cursor:pointer;font-weight:bold;">Next guest ‚û°Ô∏è</button>
<div id="motel-manager"></div>

<script>
// --- Firebase init ---
const firebaseConfig = {
    apiKey: "AIzaSyCfPJJL8cbfxmpWpHG5_icQOZjzGWSpeZI",
    authDomain: "drunk-punk.firebaseapp.com",
    projectId: "drunk-punk",
    storageBucket: "drunk-punk.firebasestorage.app",
    messagingSenderId: "749798531604",
    appId: "1:749798531604:web:9e702aee7c9a2599627d01",
    measurementId: "G-JSFRP622EL"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const firestore = firebase.firestore();
firebase.auth().onAuthStateChanged(function(user) {
  window.firebaseUserReady = !!user;
});

function saveLocalStorageToCloud() {
    var piUser = localStorage.getItem("piUser");
    if (!piUser) {
        if (!window.Pi) {
            showMsg("Pi SDK is not loaded!");
            return;
        }
        Pi.authenticate(["username"], function () { })
            .then(function (auth) {
                if (auth && auth.user && auth.user.username) {
                    localStorage.setItem("piUser", auth.user.username);
                    saveLocalStorageToCloud();
                } else {
                    showMsg("Failed to sign in.");
                }
            })
            .catch(function (err) {
                showMsg("Login error: " + err.message);
            });
        return;
    }

    // 1. St√°hni existuj√≠c√≠ cloudovou XP historii
    firestore.collection("pi_saves").doc(piUser).get().then(function(doc) {
        var oldXPHistory = [];
        if (doc.exists && doc.data().data && doc.data().data.xpHistory) {
            try {
                oldXPHistory = Array.isArray(doc.data().data.xpHistory)
                    ? doc.data().data.xpHistory
                    : JSON.parse(doc.data().data.xpHistory);
            } catch (e) { oldXPHistory = []; }
        }
        // 2. XP historie z localStorage
        var localXPHistory = [];
        try {
            localXPHistory = JSON.parse(localStorage.getItem("xpHistory") || "[]");
        } catch (e) { localXPHistory = []; }
        // 3. Spoj bez duplicit
        var allXPHistory = oldXPHistory.concat(localXPHistory.filter(function(newItem){
            return !oldXPHistory.some(function(oldItem){
                return oldItem.timestamp === newItem.timestamp && oldItem.xp === newItem.xp;
            });
        }));
        // 4. P≈ôidej aktu√°ln√≠ XP pokud je nov√©
        var currentXP = parseInt(localStorage.getItem("lihobaronFarmXP") || "0", 10);
        if (!allXPHistory.length || allXPHistory[allXPHistory.length-1].xp !== currentXP) {
            allXPHistory.push({xp: currentXP, timestamp: Date.now()});
        }
        // 5. Ulo≈æ do localStorage i do dat pro cloud
        localStorage.setItem("xpHistory", JSON.stringify(allXPHistory));
        var data = {};
        for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            data[key] = localStorage.getItem(key);
        }
        data.xpHistory = allXPHistory;
        data.piUser = piUser;

        // 6. Ulo≈æ do cloudu
        firestore.collection("pi_saves").doc(piUser).set({
            data: data,
            savedAt: new Date().toISOString()
        }).then(function () {
            showMsg("‚úÖ Game saved!");
        }).catch(function (error) {
            showMsg("Saving error: " + error.message);
        });
    });
}
function showMsg(msg) {
  var el = document.getElementById("msg");
  if (!el) return;
  el.textContent = msg;
  setTimeout(function() { el.textContent = ""; }, 1800);
}
function renderMotelHeaderBalances() {
  var coins = parseInt(localStorage.getItem("lihobaronFarmCoins") || "0");
  var pi = parseInt(localStorage.getItem("lihobaronPi") || "0");
  document.getElementById("balance-value").textContent = coins;
  document.getElementById("pi-value").textContent = pi;
}

// ----------- MOTEL + HOST LOGIKA ---------------
const FLOORS = 4;
const ROOMS_PER_FLOOR = 5;
const ROOM_PRICES = [20, 50, 70, 90];
const ROOM_EQUIP = [
  ["Bed"],
  ["Bed", "Table"],
  ["Bed", "Table", "TV", "AC"],
  ["Bed", "Table", "TV", "AC", "Minibar"]
];
const EQUIP_PRICES = {
  "Bed": 30, "Table": 22, "TV": 60, "AC": 110, "Minibar": 170
};
const STAY_SECONDS = 600; // test ‚Äî zmƒõ≈à na 180+ a≈æ bude≈° cht√≠t

function getMotelData() {
  let data = localStorage.getItem("motelRooms");
  if (data) return JSON.parse(data);
  let arr = [];
  for (let f = 0; f < FLOORS; f++) {
    let floor = [];
    for (let r = 0; r < ROOMS_PER_FLOOR; r++) {
      floor.push({ bought: false, equip: [], occupied: false, guest: null, stayEnd: null });
    }
    arr.push(floor);
  }
  return arr;
}
function saveMotelData(arr) {
  localStorage.setItem("motelRooms", JSON.stringify(arr));
}

const GUEST_NAMES = ["Karen", "John", "Marcel", "Lola", "Bob", "Helga", "Mike", "Jenny"];
const GUEST_NEEDS = [
  {equip: ["Bed"], payout: 40},
  {equip: ["Bed", "Table"], payout: 80},
  {equip: ["Bed", "Table", "TV", "AC"], payout: 150},
  {equip: ["Bed", "Table", "TV", "AC", "Minibar"], payout: 300}
];

let guestActive = null;
let guestInterval = null;

function genRandomGuest() {
  let idx = Math.floor(Math.random() * GUEST_NEEDS.length);
  let name = GUEST_NAMES[Math.floor(Math.random() * GUEST_NAMES.length)];
  return {
    name: name,
    floor: idx,
    needEquip: GUEST_NEEDS[idx].equip,
    payout: GUEST_NEEDS[idx].payout
  };
}

function renderGuestBar() {
  let bar = document.getElementById("guest-bar");
  if (!guestActive) {
    bar.style.display = "none";
    return;
  }
  let html = `<strong>New guest:</strong> <b>${guestActive.name}</b><br>
    Wants: Floor ${guestActive.floor + 1} room with <b>${guestActive.needEquip.join(", ")}</b>
    <br><br>
    <button onclick="acceptGuest()" style="background:#16a34a;color:#fff;padding:7px 15px;font-size:1.1em;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">Accept guest</button>
    <button onclick="rejectGuest()" style="background:#ed2525;color:#fff;padding:7px 15px;font-size:1.1em;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-left:10px;">Reject</button>`;
  bar.innerHTML = html;
  bar.style.display = "block";
}
window.rejectGuest = function() {
  guestActive = null;
  renderGuestBar();
};
window.acceptGuest = function() {
  let motel = getMotelData();
  let f = guestActive.floor;
  let found = false;
  for (let r = 0; r < ROOMS_PER_FLOOR; r++) {
    let room = motel[f][r];
    if (room.bought && !room.occupied && guestActive.needEquip.every(eq => room.equip.includes(eq))) {
      room.occupied = true;
      room.guest = { name: guestActive.name, payout: guestActive.payout };
      room.stayEnd = Date.now() + STAY_SECONDS * 1000;
      saveMotelData(motel);
      guestActive = null;
      renderGuestBar();
      renderMotelManager();
      startStayTimer();
      showMsg("Guest accommodated!");
      found = true;
      break;
    }
  }
  if (!found) showMsg("No available room that matches guest's needs!");
};

function startStayTimer() {
  if (guestInterval) clearInterval(guestInterval);
  guestInterval = setInterval(function() {
    let motel = getMotelData();
    let changed = false;
    for (let f = 0; f < FLOORS; f++) {
      for (let r = 0; r < ROOMS_PER_FLOOR; r++) {
        let room = motel[f][r];
        if (room.occupied && room.stayEnd && Date.now() >= room.stayEnd) {
          let coins = parseInt(localStorage.getItem("lihobaronFarmCoins") || "0");
          coins += room.guest.payout;
          localStorage.setItem("lihobaronFarmCoins", coins);
          room.occupied = false;
          room.guest = null;
          room.stayEnd = null;
          changed = true;
          showMsg("Guest has checked out! Payment received.");
        }
      }
    }
    if (changed) {
      saveMotelData(motel);
      renderMotelManager();
      renderMotelHeaderBalances();
    } else {
      renderMotelManager();
    }
  }, 1000);
}

function renderMotelManager() {
  renderMotelHeaderBalances();
  let motel = getMotelData();
  let html = '<div class="motel-title"><span style="font-size:1.3em">üè®</span> Motel Manager</div>';
  html += '<div class="rooms-grid">';
  for (let f = FLOORS - 1; f >= 0; f--) {
    for (let r = 0; r < ROOMS_PER_FLOOR; r++) {
      let room = motel[f][r];
      html += '<div class="room-card">';
      html += '<div class="room-title">Floor ' + (f + 1) + ', Room ' + (r + 1) + '</div>';
      if (!room.bought) {
        html += '<div class="room-status">Empty</div>';
        html += '<button class="buy-btn" onclick="buyRoom(' + f + ',' + r + ')">Buy<br>(' + ROOM_PRICES[f] + ' $)</button>';
      } else {
        if (room.occupied) {
          let timeLeft = Math.max(0, Math.round((room.stayEnd - Date.now()) / 1000));
          let min = Math.floor(timeLeft / 60);
          let sec = timeLeft % 60;
          let timeStr = min + "m " + (sec < 10 ? "0" : "") + sec + "s";
          html += '<div class="room-status" style="color:#d1730b;font-weight:bold;">Occupied</div>';
          html += '<div style="color:#1760a3;font-size:1.03em;">'
            + 'Guest: ' + room.guest.name
            + '<br>Checkout in: <b>' + timeStr + '</b>'
            + '<br><span style="color:#18a500;">Will pay: <b>' + room.guest.payout + ' $</b></span>'
            + '</div>';
        } else {
          html += '<div class="room-status" style="color:#269a63;font-weight:bold;">Owned</div>';
        }
        html += '<div class="equip-list">';
        let req = ROOM_EQUIP[f];
        req.forEach(equip => {
          let owned = room.equip.includes(equip);
          html +=
            '<div style="display:flex;align-items:center;justify-content:space-between;">'
            + equip
            + (owned
              ? ' <span style="color:#28a745;font-size:1em;">‚úì</span>'
              : ' <button class="equip-btn" onclick="buyEquip(' + f + ',' + r + ',\'' + equip + '\')">Buy (' + EQUIP_PRICES[equip] + ' $)</button>')
            + '</div>';
        });
        html += '</div>';
      }
      html += '</div>';
    }
  }
  html += '</div>';
  document.getElementById("motel-manager").innerHTML = html;
}

window.buyRoom = function(f, r) {
  let motel = getMotelData();
  if (motel[f][r].bought) return;
  let coins = parseInt(localStorage.getItem("lihobaronFarmCoins") || "0");
  if (coins < ROOM_PRICES[f]) {
    showMsg("Not enough cash for this room!");
    return;
  }
  coins -= ROOM_PRICES[f];
  localStorage.setItem("lihobaronFarmCoins", coins);
  motel[f][r].bought = true;
  saveMotelData(motel);
  renderMotelManager();
  renderMotelHeaderBalances();
  showMsg("Room bought!");
}

window.buyEquip = function(f, r, equip) {
  let motel = getMotelData();
  if (!motel[f][r].bought) return;
  if (motel[f][r].equip.includes(equip)) return;
  let price = EQUIP_PRICES[equip];
  let coins = parseInt(localStorage.getItem("lihobaronFarmCoins") || "0");
  if (coins < price) {
    showMsg("Not enough cash for equipment!");
    return;
  }
  coins -= price;
  localStorage.setItem("lihobaronFarmCoins", coins);
  motel[f][r].equip.push(equip);
  saveMotelData(motel);
  renderMotelManager();
  renderMotelHeaderBalances();
  showMsg("Equipment bought: " + equip);
}

document.getElementById("nextGuestBtn").onclick = function() {
  if (guestActive) {
    showMsg("You must process current guest first!");
    return;
  }
  guestActive = genRandomGuest();
  renderGuestBar();
};

window.onload = function() {
  renderMotelManager();
  renderMotelHeaderBalances();
  startStayTimer();
};

</script>
</body>
</html>
